<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slide Elements Splitter 智慧圖片裁切</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- ImageTracer for SVG conversion -->
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">

    <link rel="manifest" href="manifest.json" />
    <!-- https://www.favicon-generator.org/ -->
    <link rel="apple-touch-icon" sizes="57x57" href="assets/favicon/generator/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="assets/favicon/generator/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="assets/favicon/generator/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/favicon/generator/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="assets/favicon/generator/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/favicon/generator/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/favicon/generator/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/favicon/generator/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/generator/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="assets/favicon/generator/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/generator/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon/generator/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/generator/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#E1F7F7">
    <meta name="msapplication-TileImage" content="assets/favicon/generator/ms-icon-144x144.png">
    <meta name="theme-color" content="#E1F7F7">
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden relative">

    <!-- Drag Overlay -->
    <div id="dragOverlay" class="fixed inset-0 bg-blue-600/90 z-50 hidden flex flex-col items-center justify-center text-white backdrop-blur-sm pointer-events-none">
        <i class="fa-solid fa-cloud-arrow-up text-7xl mb-6 animate-bounce"></i>
        <h2 class="text-3xl font-bold mb-2">放開滑鼠左鍵後上傳</h2>
        <p class="text-blue-100 text-lg">支援 JPG, PNG, PDF</p>
    </div>

    <!-- Lightbox Modal (View Only) -->
    <div id="lightbox" class="fixed inset-0 z-[100] bg-black/95 hidden flex items-center justify-center overflow-hidden transition-opacity duration-300" onclick="closeLightbox()">
        <div class="w-full h-full flex items-center justify-center p-4 pointer-events-none">
            <img id="lightboxImg" src="" class="max-w-full max-h-full object-contain shadow-2xl pointer-events-auto zoom-in" onclick="toggleZoom(event)" onmousemove="panImage(event)">
        </div>
        
        <button class="absolute top-4 right-6 text-white/70 hover:text-white text-4xl transition z-[101]" onclick="closeLightbox()">&times;</button>
        
        <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-4 text-white/60 text-sm pointer-events-none bg-black/40 px-4 py-2 rounded-full backdrop-blur-sm">
            <span><i class="fa-solid fa-mouse-pointer mr-1"></i> 點擊縮放</span>
            <span><i class="fa-solid fa-up-down-left-right mr-1"></i> 移動檢視</span>
            <span><i class="fa-regular fa-keyboard mr-1"></i> ESC 關閉</span>
        </div>
    </div>

    <!-- Editor Modal (Manual Selection) -->
    <div id="editorModal" class="fixed inset-0 z-[120] bg-slate-900 hidden flex flex-col">
        <!-- Editor Header -->
        <div class="bg-slate-800 text-white px-4 py-3 flex justify-between items-center shadow-md z-10">
            <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-crop-simple"></i> 手動選取</h3>
            <div class="flex gap-2 items-center" id="editorToolbar">
                
                <!-- Tool Selection -->
                <div class="flex bg-slate-700 rounded-lg p-1 mr-2">
                    <button onclick="setEditorTool('rect')" id="tool-rect" class="px-3 py-1.5 rounded text-sm transition" title="矩形"><i class="fa-regular fa-square"></i></button>
                    <button onclick="setEditorTool('lasso')" id="tool-lasso" class="px-3 py-1.5 rounded text-sm transition" title="圈索"><i class="fa-solid fa-draw-polygon"></i></button>
                    <button onclick="setEditorTool('brush')" id="tool-brush" class="px-3 py-1.5 rounded text-sm transition" title="筆刷"><i class="fa-solid fa-paintbrush"></i></button>
                </div>

                <!-- Mode Selection -->
                <div class="flex bg-slate-700 rounded-lg p-1 mr-2 text-xs font-medium">
                    <button onclick="setEditorMode('add')" id="mode-add" class="px-3 py-1.5 rounded transition flex items-center gap-1"><i class="fa-solid fa-plus"></i> 增加</button>
                    <button onclick="setEditorMode('remove')" id="mode-remove" class="px-3 py-1.5 rounded transition flex items-center gap-1"><i class="fa-solid fa-minus"></i> 移除</button>
                </div>

                <div class="w-px h-6 bg-slate-600 mx-1"></div>
                
                <button onclick="clearEditor()" class="bg-slate-700 hover:bg-red-900 text-white px-3 py-2 rounded-lg text-sm transition mr-2" title="清除全部選取">
                    <i class="fa-solid fa-trash-can"></i>
                </button>

                <button onclick="confirmEditorSelection()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition font-bold shadow-sm flex items-center">
                    <i class="fa-solid fa-check mr-1"></i> 建立圖片
                </button>
                <button onclick="closeEditor()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-sm transition ml-2">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Editor Canvas Area -->
        <div class="flex-1 overflow-hidden relative bg-slate-900 flex items-center justify-center p-4 checkerboard-bg" id="editorCanvasContainer">
            <!-- Canvas stack -->
            <div class="relative shadow-2xl" id="editorStack">
                <canvas id="editorBaseCanvas" class="block"></canvas> <!-- Original Image -->
                <canvas id="editorOverlayCanvas" class="absolute inset-0 cursor-crosshair"></canvas> <!-- Drawing Layer -->
            </div>
        </div>
        
        <div class="bg-slate-800 text-slate-400 text-xs px-4 py-2 text-center flex justify-center gap-6">
            <span><i class="fa-solid fa-mouse-pointer mr-1"></i> 左鍵拖曳選取</span>
            <span><i class="fa-solid fa-layer-group mr-1"></i> 模式：增加(綠色) / 移除(紅色)</span>
            <span><i class="fa-solid fa-check mr-1"></i> 按下「建立圖片」完成</span>
        </div>
    </div>

    <!-- Text Result Modal -->
    <div id="textResultModal" class="fixed inset-0 bg-black/50 z-[130] hidden flex items-center justify-center backdrop-blur-sm" onclick="closeTextModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden flex flex-col max-h-[80vh] animate-[fadeIn_0.2s_ease-out]" onclick="event.stopPropagation()">
            <div class="bg-blue-700 text-white px-6 py-4 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-file-lines mr-2"></i> 辨識結果</h3>
                <button onclick="closeTextModal()" class="text-white/70 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <textarea id="textResultContent" class="p-6 w-full h-full resize-none focus:outline-none text-slate-700 leading-relaxed overflow-y-auto"></textarea>
            <div class="p-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-2 shrink-0">
                <button onclick="copyTextResult()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm flex items-center">
                    <i class="fa-regular fa-copy mr-2"></i> 複製文字
                </button>
                <button onclick="closeTextModal()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-medium transition">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- API & Global Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden transform transition-all flex flex-col max-h-[90vh]">
            <div class="bg-slate-800 text-white px-6 py-4 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-sliders mr-2"></i>設定與參數</h3>
                <button onclick="toggleSettingsModal()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-6 overflow-y-auto custom-scrollbar">
                
                <!-- Section 1: Global Parameters -->
                <div class="space-y-4 border-b border-slate-200 pb-6">
                    <h4 class="font-bold text-slate-700 flex items-center"><i class="fa-solid fa-crop-simple mr-2"></i> 全域裁切參數 (預設值)</h4>
                    <p class="text-xs text-slate-500 mb-2">這些設定將應用於新上傳的圖片或點擊「套用全域」時。</p>
                    
                    <!-- Size -->
                    <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-center">
                            <label class="font-semibold text-sm text-slate-600">最小區塊 (%)</label>
                            <input type="number" id="g_sizeInput" min="0" max="100" step="0.1" 
                                class="w-16 text-right px-2 py-1 border border-slate-300 rounded text-blue-600 font-bold focus:outline-none focus:border-blue-500">
                        </div>
                        <input type="range" id="g_size" min="0" max="50" step="0.1" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    
                    <!-- Merge -->
                    <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-center">
                            <label class="font-semibold text-sm text-slate-600">合併距離 (%)</label>
                            <input type="number" id="g_mergeInput" min="0" max="50" step="0.5" 
                                class="w-16 text-right px-2 py-1 border border-slate-300 rounded text-blue-600 font-bold focus:outline-none focus:border-blue-500">
                        </div>
                        <input type="range" id="g_merge" min="0" max="20" step="0.5" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    
                    <!-- Tolerance -->
                    <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-center">
                            <label class="font-semibold text-sm text-slate-600">顏色容忍度</label>
                            <input type="number" id="g_tolInput" min="1" max="100" step="1" 
                                class="w-16 text-right px-2 py-1 border border-slate-300 rounded text-blue-600 font-bold focus:outline-none focus:border-blue-500">
                        </div>
                        <input type="range" id="g_tol" min="1" max="100" step="1" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>

                    <button onclick="applyGlobalToAll()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 rounded-lg transition border border-slate-300 text-sm">
                        <i class="fa-solid fa-check-double mr-1"></i> 強制套用至目前所有圖片
                    </button>
                </div>

                <!-- Section 2: API Settings -->
                <div class="space-y-4">
                    <h4 class="font-bold text-slate-700 flex items-center"><i class="fa-solid fa-robot mr-2"></i> Gemini API 設定</h4>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">
                            API Key 
                            <a href="https://aistudio.google.com/app/api-keys" target="_blank" class="text-blue-500 hover:text-blue-700 text-xs ml-1 font-normal underline decoration-blue-300 decoration-1 underline-offset-2">
                                <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i> 申請 API Key
                            </a>
                        </label>
                        <input type="password" id="apiKeyInput" placeholder="輸入您的 Google Gemini API Key" 
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Model Name</label>
                        <input type="text" id="modelInput" value="gemini-flash-latest" placeholder="例如: gemini-flash-latest" 
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Base URL (選填)</label>
                        <input type="text" id="baseUrlInput" value="https://generativelanguage.googleapis.com" placeholder="預設為 Google 官方位置" 
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition text-sm">
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-200 bg-slate-50 shrink-0">
                <button onclick="saveApiSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition shadow-md">
                    儲存並關閉
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm z-20 border-b border-slate-200 flex-shrink-0">
        <div class="max-w-[1920px] mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="text-slate-500 hover:text-blue-600 focus:outline-none transition p-1 rounded-md hover:bg-slate-100" title="切換目錄顯示">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-crop-simple text-blue-600 text-2xl"></i>
                        <h1 class="text-xl font-bold text-slate-800">智慧圖片裁切</h1>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <input id="pdfUrlInput" type="url" value="demo/demo.pdf" placeholder="輸入 PDF 網址" class="w-full md:w-[420px] px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition" />
                        <button id="pdfUrlButton" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition shadow-sm whitespace-nowrap">
                            <i class="fa-solid fa-link"></i>
                            <span class="text-sm font-medium">下載並上傳</span>
                        </button>
                    </div>
                    <button onclick="togglePromptsModal()" class="flex items-center gap-2 text-slate-600 hover:text-blue-600 bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-lg transition border border-slate-200" title="常用提示詞">
                        <i class="fa-solid fa-message text-lg"></i>
                        <span class="text-sm font-medium">提示詞</span>
                    </button>
                    <button onclick="toggleSettingsModal()" class="flex items-center gap-2 text-slate-600 hover:text-blue-600 bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-lg transition border border-slate-200" title="設定與參數">
                        <i class="fa-solid fa-gear text-lg"></i>
                        <span class="text-sm font-medium">設定</span>
                    </button>
                    <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium transition shadow-sm flex items-center">
                        <i class="fa-solid fa-upload mr-2"></i> 上傳 / 貼上
                        <input type="file" id="fileInput" multiple accept="image/*,application/pdf" class="hidden">
                    </label>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Flex Container -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar (TOC) -->
        <aside id="mainSidebar" class="hidden flex-col w-56 bg-white border-r border-slate-200 flex-shrink-0 z-10 transition-all duration-300">
            <div class="p-3 border-b border-slate-100 bg-slate-50 font-bold text-slate-600 text-sm flex items-center justify-between">
                <span><i class="fa-solid fa-list-ul mr-2"></i> 頁面目錄</span>
                <button onclick="toggleSidebar()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="sidebarContent" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar bg-slate-50/50">
                <!-- Sidebar items injected here -->
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="mainScrollArea" class="flex-1 overflow-y-auto px-4 py-6 bg-slate-50 scroll-smooth relative">
            
            <!-- Status -->
            <div id="statusMsg" class="hidden text-center py-4 absolute inset-x-0 top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-100 shadow-sm">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl text-blue-500 mr-2"></i>
                <span id="statusText" class="text-slate-500 font-medium">處理中...</span>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="flex flex-col items-center justify-center py-20 text-slate-400 border-2 border-dashed border-slate-300 rounded-xl bg-white/50 hover:bg-white hover:border-blue-400 cursor-pointer transition mt-8" onclick="document.getElementById('fileInput').click()">
                <i class="fa-regular fa-folder-open text-5xl mb-4 text-slate-300"></i>
                <h3 class="text-lg font-medium text-slate-600">拖曳檔案、貼上 (Ctrl+V) 或 點擊上傳</h3>
            </div>

            <!-- Results Area -->
            <div id="resultsArea" class="flex flex-col gap-8 hidden pb-20">
                <!-- Cards injected here -->
            </div>
        </main>

    </div>

    <!-- Prompts Modal -->
    <div id="promptsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden transform transition-all flex flex-col max-h-[80vh]">
            <div class="bg-slate-800 text-white px-6 py-4 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-message mr-2"></i> 常用提示詞</h3>
                <button onclick="togglePromptsModal()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-4 overflow-y-auto custom-scrollbar flex-1">
                <div class="flex gap-2">
                    <input type="text" id="newPromptInput" placeholder="輸入新的提示詞..." 
                        class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition text-sm">
                    <button onclick="addPrompt()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition shadow-sm whitespace-nowrap">
                        <i class="fa-solid fa-plus mr-1"></i> 新增
                    </button>
                </div>
                
                <div id="promptsList" class="space-y-2">
                    <!-- Prompts will be injected here -->
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-200 bg-slate-50 shrink-0">
                <button onclick="togglePromptsModal()" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 rounded-lg transition">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg transition-opacity opacity-0 pointer-events-none z-50 flex items-center gap-2">
        <span id="toastIcon"></span>
        <span id="toastMsg">Notification</span>
    </div>

    <!-- Application Scripts -->
    <script src="js/state.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/ocr.js"></script>
    <script src="js/pdf.js"></script>
    <script src="js/detection.js"></script>
    <script src="js/core.js"></script>
    <script src="js/render.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
